Ext.define("UBE.GraphViewer",{extend:"Ext.Panel",alias:"widget.graphviewer",width:"100%",height:"100%",layout:"fit",cls:"mx-graph-editor",initComponent:function(){var e=this;e.tbar={xtype:"toolbar",items:[{xtype:"button",text:"Zoom",mxAction:"zoomIn",handler:e.actionHandler,scope:e},{xtype:"button",text:"Zoom Out",mxAction:"zoomOut",handler:e.actionHandler,scope:e},{xtype:"button",text:"Actual Size",mxAction:"actualSize",handler:e.actionHandler,scope:e},{xtype:"button",text:"Fit",mxAction:"fit",handler:e.actionHandler,scope:e},{xtype:"button",text:"Edit",handler:e.editDiagram,scope:e}]},e.containerId=Ext.id(),e.dataUrl=null,e.html='<div id="'+e.containerId+'" class="graph-editor-holder" style="width: 100%; height: 100%;"></div>',e.on({boxready:function(t){window.isDeveloperMode?e.initMXEditor():UB.inject(window.mxBasePath+"/js/mxClient.js").then(function(){return UB.inject(window.mxBasePath+"/js/graphEditor/Shapes.js")}).done(function(){e.initMXEditor()})},resize:function(){e.editor.graph.sizeDidChange()},scope:e}),e.callParent(arguments)},setSrc:function(e){var t=this,n=e.url;return t.dataUrl=n,t.editor&&t.editor.open(e.url),Q.resolve(!0)},initMXEditor:function(){var e,t,n=mxUtils.load(window.mxBasePath+"/resources/config/graphviewer.xml").getDocumentElement(),i=this;i.editor=e=new mxEditor(n),t=e.graph,e.setGraphContainer(document.getElementById(i.containerId)),e.graph.cellsEditable=!1,e.graph.cellsDeletable=!1,e.graph.cellsMovable=!1,e.graph.edgeLabelsMovable=!1,e.graph.vertexLabelsMovable=!1,e.graph.dropEnabled=!1,e.graph.splitEnabled=!1,e.graph.cellsResizable=!1,e.graph.cellsBendable=!1,e.graph.cellsSelectable=!1,e.graph.cellsDisconnectable=!1,e.graph.cellsCloneable=!1,e.graph.allowDanglingEdges=!1,e.graph.disconnectOnMove=!1,e.showTasks=function(){},e.refreshTasks=function(){},e.showProperties=function(){},e.hideProperties=function(){},t.popupMenuHandler.factoryMethod=function(){},t.setResizeContainer(!0),new mxRubberband(t),t.setPanning(!0),t.setTooltips(!0),i.dataUrl&&i.editor.open(i.dataUrl)},beforeDestroy:function(){var e=this;e.editor&&e.editor.destroy(),e.callParent(arguments)},actionHandler:function(e){this.editor.execute(e.mxAction)},editDiagram:function(e){var t=(new mxCodec).encode(this.editor.graph.getModel());Ext.create("UB.view.Workflow",{incomeModel:t,resultCallBack:Ext.bind(this.onEndEdit,this),constrain:!0,commandCode:!0,modal:!0,layout:{type:"hbox",align:"stretch"}})},onEndEdit:function(e,t){var n,i,a,o,r,l=this;e&&(a=(i=l.up("basepanel")).getUBCmp("attrDocument"),r=i.record.get("document"),(n={entity:a.entityName,attribute:a.attributeName,ID:a.instanceID}).origName=r?r.origName:l.baseMIME&&l.baseMIME.indexOf("/")<l.baseMIME.length-1?"file."+l.baseMIME.substr(l.baseMIME.indexOf("/")+1):"",n.filename=r?r.filename:n.origName,(Ext.isEmpty(n.filename)||""===n.filename)&&(n.origName="unknown.xml",n.filename="unknown.xml"),o=mxUtils.getXml(t),UB.core.UBService.setDocument(n,"POST",o,function(e){var n=Ext.JSON.decode(e);if(n.success){var a=Ext.JSON.encode(n.result);i.getUBCmp(UB.core.UBCommand.getUBCmpUBName("document")).setValue(a,i.instanceID),this.editor.readGraphModel(t)}},this))}}),window.mxBasePath="models/UBE/mxGraph",UB.ux.UBDocument.contentTypeMapping["application/ubWorkFlow"]="UBE.GraphViewer",UB.ux.UBDocument.contentTypeMapping["application/ubworkflow"]="UBE.GraphViewer",Ext.define("UBE.UBMetaDiagram",{extend:"Ext.Panel",alias:"widget.UBMetaDiagram",width:"100%",height:"100%",layout:"fit",statics:{mixinPictures:{mStorage:'<i class="fa fa-database"></i>',dataHistory:'<i class="fa fa-clock-o"></i>',unity:'<i class="fa fa-toggle-off"></i>',tree:'<i class="fa fa-sitemap"></i>',fts:'<i class="fa fa-search"></i>',rls:'<i class="fa fa-tasks"></i>',als:'<i class="fa fa-table"></i>',aclRls:'<i class="fa fa-tasks">a</i>',audit:'<i class="fa fa-pencil-square-o"></i>',softLock:'<i class="fa fa-key"></i>',clobTruncate:"ct"}},initComponent:function(){var e,t,n,i,a=this;a.addEvents("change"),a.items=a.items||[],a.initObjectTree(),Ext.EventManager.on(document,"mouseup",a.onmouseUpFunc,a),Ext.EventManager.on(document,"mousemove",a.onmousemoveFunc,a),a.idPrefix=Ext.id(null),a.containerId=e=a.idPrefix+"graph",t='<div id="'+e+'" class="graph-editor-holder" style="width: 100%; height: 100%;-moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;" tabindex="0"></div>',a.editPnl=Ext.create("Ext.panel.Panel",{region:"center",cls:"mx-graph-editor",flex:1,html:t,listeners:{boxready:function(){UB.inject("models/UBE/mxGraph/mxClient"+(window.isDeveloperMode?"":".min")+".js").then(function(){a.initMXEditor()})},resize:function(){this.editor&&this.editor.graph&&this.editor.graph.sizeDidChange()},scope:a}}),a.toolbarId=e=a.idPrefix+"toolbar",n='<div id="'+e+'" tabindex="0"></div>',a.outlineId=e=a.idPrefix+"outline",i='<div id="'+e+'" ></div>',a.menuPnl=Ext.create("Ext.panel.Panel",{height:"100%",region:"west",split:!0,collapsible:!0,width:250,layout:{type:"border"},items:[{xtype:"tabpanel",region:"center",deferredRender:!1,split:!0,height:"auto",bodyStyle:"background:white;",items:[a.objectTree,{xtype:"panel",region:"center",autoRender:!0,title:UB.i18n("toolbar"),html:n,listeners:{boxready:function(e){},scope:a}}]},{xtype:"panel",region:"south",split:!0,height:160,fit:2,html:i}]});var o=Ext.create("Ext.panel.Panel",{layout:{type:"border"},defaults:{split:!0},items:[a.menuPnl,a.editPnl]});a.items.push(o),a.callParent(arguments)},isDirty:function(){return!!this.editor&&this.editor.isModified()},onmousemoveFunc:function(e){var t=this;if(t.dragDropObj&&t.dragDropObj.dragElm){var n=e.getXY();Ext.get(t.dragDropObj.dragElm).position("absolute",t.dragDropObj.dragElm.style.zIndex,n[0],n[1])}},onmouseUpFunc:function(e){var t,n,i,a=this;a.dragDropObj&&a.graphDivEl&&(a.dragDropObj.dragElm&&a.dragDropObj.dragElm.parentNode.removeChild(a.dragDropObj.dragElm),t=e.getX(),n=e.getY(),a.graphDivEl.getX()>t||a.graphDivEl.getX()+a.graphDivEl.getWidth()<t||a.graphDivEl.getY()>n||a.graphDivEl.getY()+a.graphDivEl.getHeight()<n?a.dragDropObj=null:(t=mxEvent.getClientX(e.browserEvent),n=mxEvent.getClientY(e.browserEvent),i=mxUtils.convertPoint(a.editor.graph.container,t,n),a.addObjectToDiagram(i,a.dragDropObj),a.dragDropObj=null))},addObjectToDiagram:function(e,t){var n,i,a,o,r,l,d=this,s={},c=t.objectName,u=!1;if(Ext.Object.each(d.editor.graph.model.cells,function(e,t){var n=t.getAttribute("objectCode");return!n||(c.toUpperCase()===n.toUpperCase()?(u=!0,!1):void 0)},d),u)return $App.dialogError("Object exist in diagram").done(),!1;(i=mxUtils.createXmlDocument().createElement("ubObject")).setAttribute("label",c),i.setAttribute("objectCode",c),(n=new mxCell(i,new mxGeometry(0,0,187,147),"verticalAlign=top;align=left;overflow=fill;html=1")).vertex=!0,a=$App.domainInfo.get(c),d.editor.addVertex(null,n,e.x,e.y),a.eachAttribute(function(e,t){if(Ext.String.startsWith(t,"mi_",!0))return!0;"Entity"===e.dataType&&"ID"!==t.toUpperCase()&&((l=s[e.associatedEntity])||(s[e.associatedEntity]=l=[]),l.push({linkType:"relation",srcObj:c,srcProp:t,destObj:e.associatedEntity,destProp:"ID"}))}),a.mixins&&a.mixins.unity&&((l=s[a.mixins.unity.entity])||(s[a.mixins.unity.entity]=l=[]),l.push({linkType:"inheritage",srcObj:c,srcProp:"ID",destObj:a.mixins.unity.entity,destProp:"ID"})),Ext.Object.each(d.editor.graph.model.cells,function(e,t){var i=t.getAttribute("objectCode");return!i||(!(o=$App.domainInfo.get(i))||(o.mixins&&o.mixins.unity&&o.mixins.unity.entity===c&&(r={linkType:"inheritage",srcObj:i,srcProp:"ID",destObj:c,destProp:"ID"},d.editor.graph.addEdge(d.createEdge(r),null,t,n)),s[i]&&Ext.Array.each(s[i],function(e){d.editor.graph.addEdge(d.createEdge(e),null,n,t)},d),void(i!==c&&o.eachAttribute(function(e,a){if(Ext.String.startsWith(a,"mi_",!0))return!0;"Entity"===e.dataType&&"ID"!==a.toUpperCase()&&e.associatedEntity===c&&(r={linkType:"relation",srcObj:i,srcProp:a,destObj:c,destProp:"ID"},d.editor.graph.addEdge(d.createEdge(r),null,t,n))}))))},d)},createEdge:function(e){var t,n,i;return n=mxUtils.createXmlDocument(),(i=n.createElement("ubObject")).setAttribute("linkType",e.linkType),i.setAttribute("srcObj",e.srcObj),i.setAttribute("srcProp",e.srcProp),i.setAttribute("destObj",e.destObj),i.setAttribute("destProp",e.destProp),"relation"===e.linkType&&((t=new mxCell(i,new mxGeometry(0,0,0,0),"endArrow=open;endSize=10;startArrow=diamondThin;startSize=10;startFill=0;edgeStyle=orthogonalEdgeStyle;")).geometry.setTerminalPoint(new mxPoint(0,0),!0),t.geometry.setTerminalPoint(new mxPoint(80,0),!0),t.geometry.setTerminalPoint(new mxPoint(160,0),!1),t.edge=!0),"inheritage"===e.linkType&&((t=new mxCell(i,new mxGeometry(0,0,0,0),"endArrow=block;endSize=10;endFill=0;startArrow=oval;startFill=0;startSize=7;edgeStyle=segmentEdgeStyle;fillColor=#0B31D9;strokeColor=#0B31D9;")).geometry.setTerminalPoint(new mxPoint(0,0),!0),t.geometry.setTerminalPoint(new mxPoint(80,0),!0),t.geometry.setTerminalPoint(new mxPoint(160,0),!1),t.edge=!0),t},initObjectTree:function(){var e,t,n=this,i=[],a={};$App.domainInfo.eachEntity(function(e,t){var n=e.modelName,o=a[n];o?o.children.push({text:t,leaf:!0,icon:null,objCode:t}):(o={text:n,expanded:!1,children:[],icon:null},a[n]=o,i.push(o),o.children.push({text:t,leaf:!0,icon:null,objCode:t}))}),e={root:{expanded:!0,children:i}},t=Ext.create("Ext.data.TreeStore",e),n.objectTree=Ext.create("Ext.tree.Panel",{title:UB.i18n("entities"),flex:1,singleExpand:!0,region:"north",store:t,rootVisible:!1,listeners:{itemmousedown:function(e,t,i,a,o){if(t.isLeaf()){var r,l,d,s,c;r=document.createElement("DIV"),c=n.getContainer().getEl(),document.documentElement.appendChild(r),l=Ext.get(r),d=Ext.get(i),r.style.border="1px solid black",r.style.opacity=1,r.style.backgroundColor="white",l.setWidth(d.getWidth()),l.setHeight(d.getHeight()),s=o.getXY(),l.position("absolute",c.dom.style.zIndex+2,s[0],s[1]),n.dragDropObj={objectName:t.get("text"),dragElm:r}}},scope:n}})},useBlobForData:!0,getDataBlob:function(){var e=this;return e.useBlobForData||Ext.Error.raise("object does not use Blob"),e.dataBlob},updateDataBlob:function(e){var t=this;t.useBlobForData||Ext.Error.raise("object does not use Blob"),t.dataBlob&&!Ext.isEmpty(this.objUrl)&&window.URL.revokeObjectURL(this.objUrl),t.data=null,t.dataBlob=e,t.objUrl=window.URL.createObjectURL(e),t.data=t.objUrl},onDestroy:function(){var e=this;e.dataBlob=null,e.data=null,e.useBlobForData&&!Ext.isEmpty(e.objUrl)&&window.URL.revokeObjectURL(e.objUrl),e.objUrl=null,this.callParent()},setSrc:function(e){var t,n=this,i=e.url,a=e.blobData;return t=function(){if(n.changeFired=!0,n.editor){n.isInitEditor=!0;try{n.editor.open(n.objUrl)}finally{n.isInitEditor=!1}n.validateDiagram(),n.editor.setMode("select")}n.changeFired=!1},n.dataUrl=i,n.useBlobForData?a?(n.updateDataBlob(a),t(),Q.resolve(!0)):$App.connection.get(n.dataUrl,{responseType:"arraybuffer"}).then(function(i){var a,o=i.data;a=new Blob([o],{type:e.contentType}),n.updateDataBlob(a),t()}).fail(function(t){404===t.status&&(e.onContentNotFound?e.onContentNotFound():UB.showErrorWindow('<span style="color: red">'+UB.i18n("documentNotFound")+"<span/>"))}):(n.objUrl=n.dataUrl,t(),Q.resolve(!0))},validateDiagram:function(){var e,t,n,i,a,o,r,l,d,s,c,u,g,p=this,h=p.editor.graph,m={},x={};Ext.Object.each(p.editor.graph.model.cells,function(e,t){if(!(n=t.getAttribute("objectCode")))return!0;x[n.toLowerCase()]=t}),Ext.Object.each(p.editor.graph.model.cells,function(f,E){if(!(n=E.getAttribute("objectCode")))return!0;if(!(e=$App.domainInfo.get(n)))return p.editor.graph.removeCells([E],!0),!0;g=!1;for(var y=E.getEdgeCount()-1;y>-1;y--){switch(i=E.getEdgeAt(y),a=i.getAttribute("srcObj")||"",o=i.getAttribute("srcProp")||"",r=i.getAttribute("destObj")||"",l=i.getAttribute("destProp")||"",d=i.getAttribute("linkType")||"relation",u="inheritage"===d,c=!1,n){case a:s=e.attr(o),t=$App.domainInfo.get(r),u?(c=!s||!(e.mixins&&e.mixins.unity&&e.mixins.unity.entity===r),g=!c):c=!s||"Entity"!==s.dataType||"ID"===o.toUpperCase()||s.associatedEntity.toLowerCase()!==r.toLowerCase()||Ext.String.startsWith(o.toLowerCase(),"mi_",!0),c=c||!x[r.toLowerCase()],s&&(m[o]=s);break;case r:s=e.attr(l),c=(c=!s)||!x[a.toLowerCase()],t=$App.domainInfo.get(a);break;default:s=null,c=!0}if(t||(c=!0),c){h.model.beginUpdate();try{h.cellsRemoved([i])}finally{h.model.endUpdate()}}}if(!g&&e.mixins&&e.mixins.unity&&x[e.mixins.unity.entity]){var b={linkType:"inheritage",srcObj:n,srcProp:"ID",destObj:e.mixins.unity.entity,destProp:"ID"};p.editor.graph.addEdge(p.createEdge(b),null,E,x[e.mixins.unity.entity])}Ext.Object.each(e.attributes,function(e,t){if(Ext.String.startsWith(e,"mi_",!0))return!0;if("Entity"===t.dataType&&"ID"!==e.toUpperCase()&&x[t.associatedEntity.toLowerCase()]&&!m[e]){var i={linkType:"relation",srcObj:n,srcProp:e,destObj:t.associatedEntity,destProp:"ID"};p.editor.graph.addEdge(p.createEdge(i),null,E,x[t.associatedEntity.toLowerCase()])}})},p)},getContainer:function(){return this.up("basewindow")||this.up("basepanel")},initMXEditor:function(){var e,t,n,i,a=mxUtils.load("models/UBE/resources/config/ubmetaeditor.xml").getDocumentElement(),o=this;i=o.getContainer(),o.editor=e=new mxEditor(a),t=e.graph,o.graphDivEl=Ext.get(o.containerId),n=o.graphDivEl.dom,e.setGraphContainer(n),new Ext.Element(e.toolbar.toolbar.container).up("div.mxWindow").remove(),Ext.get(o.toolbarId).dom.appendChild(e.toolbar.toolbar.container),e.keyHandler.handler.target=o.getEl().dom,mxEvent.addListener(e.keyHandler.handler.target,"keydown",e.keyHandler.handler.keydownHandler),e.keyHandler.handler.isGraphEvent=function(e){return o.isGraphEvent(e,this)},e.setModified=function(t){e.modified=t,t&&o.graphChanged()},t.popupMenuHandler.factoryMethod=mxUtils.bind(this,function(t,n,a){var o=i.getEl().dom;return t.div.parent=o,t.zIndex=o.style.zIndex+1,t.div.style.zIndex=o.style.zIndex+1,e.createPopupMenu(t,n,a)}),o.initGraph(),e.graph.cellsDisconnectable=!1,e.graph.cellsCloneable=!1,e.graph.allowDanglingEdges=!1,e.graph.disconnectOnMove=!1,e.showOutline();var r=new Ext.Element(e.outline.div).down("div.mxWindowPane");if(Ext.get(o.outlineId).appendChild(r),e.outline.setVisible(!1),e._showTasks=e.showTasks,e.tasks&&(e.tasks.destroy(),e.tasks=null),e.showTasks=Ext.Function.bind(o.showTasks,o),e.refreshTasks=Ext.Function.bind(o.refreshTasks,o),e.properties=null,e.showProperties=Ext.Function.bind(o.showProperties,o),e.hideProperties=Ext.Function.bind(o.hideProperties,o),e.addAction("edit",function(t,n){if(n){var i=n.getAttribute("objectCode");i?o.showEntityForm(i):e.graph.isEnabled()&&e.graph.isCellEditable(n)&&e.graph.startEditingAtCell(n)}}),t.getTooltipForCell=o.getTooltipForCell,t.tooltipHandler.zIndex=i.getEl().dom.style.zIndex+1,t.setResizeContainer(!0),new mxRubberband(t),t.setPanning(!0),t.setTooltips(!0),o.objUrl){o.isInitEditor=!0;try{o.editor.open(o.objUrl)}finally{o.isInitEditor=!1}}},showEntityForm:function(e){var t,n,i,a,o,r,l,d=this;if(d.editEntityFrm||(t=Ext.create("Ext.data.Store",{fields:["code","caption","size","dataType","associatedEntity","accessType","allowNull","isUnique","defaultValue","allowSort"],data:{attributes:[{}]},proxy:{type:"memory",reader:{type:"json",root:"attributes"}}}),n=Ext.create("Ext.data.Store",{fields:["icon","code","enabled"],proxy:{type:"memory",reader:{type:"json",root:"mixins"}}}),d.editEntityFrm=Ext.create("UB.view.BaseWindow",{title:"Entity",height:500,width:600,closeAction:"hide",autoDestroy:!1,modal:!0,stateful:!0,stateId:"ubMetaDiagrm_entityform",layout:{type:"border"},items:[{xtype:"tabpanel",deferredRender:!1,region:"center",items:[{title:UB.i18n("AsTаble"),layout:{type:"border"},items:[l=Ext.create("Ext.grid.Panel",{tbar:["Search",{xtype:"textfield",name:"searchField",hideLabel:!0,width:200,listeners:{change:{fn:function(){r(this)},buffer:100}}}],region:"center",split:!0,itemId:"colGrid",flex:1,title:UB.i18n("Attributes"),store:t,columns:[{text:UB.i18n("code"),dataIndex:"code"},{text:UB.i18n("caption"),dataIndex:"caption"},{text:UB.i18n("dataType"),dataIndex:"dataType"},{text:UB.i18n("size"),width:60,dataIndex:"size"},{text:UB.i18n("associatedEntity"),dataIndex:"associatedEntity"},{text:UB.i18n("accessType"),dataIndex:"accessType"},{text:UB.i18n("allowNull"),width:50,dataIndex:"allowNull"},{text:UB.i18n("isUnique"),width:50,dataIndex:"isUnique"},{text:UB.i18n("defaultValue"),dataIndex:"defaultValue"},{text:UB.i18n("allowSort"),width:50,dataIndex:"allowSort"}],listeners:{select:function(e,t){var n=d.editEntityFrmEditor.selEntity.attributes[t.get("code")];a.setValue(t.get("code")+" =\n"+JSON.stringify(n,null,"\t"))},scope:d}}),{xtype:"ubcodemirror",mode:"application/x-javascript",itemId:"edtAttr",width:250,region:"east",showLineNumbers:!1,split:!0},{height:120,region:"south",layout:{type:"border"},split:!0,items:[{xtype:"gridpanel",region:"center",split:!0,itemId:"mixGrid",flex:1,title:UB.i18n("Mixins"),store:n,columns:[{text:"-",dataIndex:"icon"},{text:UB.i18n("code"),dataIndex:"code"},{text:UB.i18n("enabled"),dataIndex:"enabled"}],listeners:{select:function(e,t){o.setValue(t.get("code")+" =\n"+JSON.stringify(d.editEntityFrmEditor.selEntity.mixins[t.get("code")],null,"\t"))},scope:d}},{xtype:"ubcodemirror",mode:"application/x-javascript",itemId:"edtMixin",width:250,region:"east",showLineNumbers:!1,split:!0}]}]},{itemId:"myEditor",xtype:"ubcodemirror",mode:"application/x-javascript",title:UB.i18n("AsJSON"),height:"100%",style:{background:"white"},hideLabel:!1}]}]}),d.editEntityFrmEditor=d.editEntityFrm.down("[itemId=myEditor]"),d.editEntityFrmEditor.fColGrd=d.editEntityFrm.down("[itemId=colGrid]"),d.editEntityFrmEditor.fmixGrid=d.editEntityFrm.down("[itemId=mixGrid]"),a=d.editEntityFrm.down("[itemId=edtAttr]"),o=d.editEntityFrm.down("[itemId=edtMixin]"),r=function(e){var t=l.getStore(),n=e.getValue();t.clearFilter(!0);var i=new RegExp(n,"i");t.filter([{filterFn:function(e){return i.test(e.get("code"))||i.test(e.get("caption"))||i.test(e.get("dataType"))||i.test(e.get("associatedEntity"))||i.test(e.get("size"))||i.test(e.get("accessType"))}}])}),i=$App.domainInfo.get(e),d.editEntityFrmEditor.selEntity=i,i){d.editEntityFrmEditor.setValue(JSON.stringify(i,null,"\t"));var s=[];i.eachAttribute(function(e,t){var n=Ext.clone(e);n.code=t,s.push(n)});var c=[];Ext.Object.each(i.mixins,function(e,t){var n=Ext.clone(t);n.code=e,n.icon=UBE.UBMetaDiagram.mixinPictures[e]||e,c.push(n)}),d.editEntityFrm.setTitle(e),d.editEntityFrmEditor.fColGrd.getStore().loadRawData({attributes:s},!1),d.editEntityFrmEditor.fmixGrid.getStore().loadRawData({mixins:c},!1),d.editEntityFrm.down("[itemId=edtAttr]").setValue(" "),d.editEntityFrm.down("[itemId=edtMixin]").setValue(" "),d.editEntityFrm.show()}},isGraphEvent:function(e,t){var n=mxEvent.getSource(e);if(n===t.target||n.parentNode===t.target||null!==t.graph.cellEditor&&n===t.graph.cellEditor.textarea)return!0;for(var i=n;null!==i;){if(i===t.target)return!0;i=i.parentNode}for(i=n;null!==i;){if(i===t.graph.container)return!0;i=i.parentNode}return!1},getTooltipForCell:function(e){var t,n;return(t=e.getAttribute("objectCode"))?(n=$App.domainInfo.get(t)).caption+": "+n.description:(t=e.getAttribute("srcProp"))?"relation"===(e.getAttribute("linkType")||"relation")?e.getAttribute("srcObj")+"."+t+" -> "+e.getAttribute("destObj")+"."+e.getAttribute("destProp"):e.getAttribute("srcObj")+" inherit "+e.getAttribute("destObj"):void 0},graphChanged:function(){this.isInitEditor||this.fireEvent("change",this)},initGraph:function(){var e=this,t=e.editor.graph;mxVertexHandler.prototype.rotationEnabled=!0,mxVertexHandler.prototype.manageSizers=!0,mxVertexHandler.prototype.livePreview=!0,t.graphHandler.guidesEnabled=!0,t.allowLoops=!0,t.isHtmlLabel=function(e){var n=t.view.getState(e),i=n?n.style:t.getCellStyle(e);return i.html+""=="1"||i.whiteSpace+""=="wrap"},t.cellRenderer.getLabelValue=function(e){var n=mxCellRenderer.prototype.getLabelValue.apply(t.cellRenderer,arguments);return e.style.whiteSpace+""=="wrap"&&e.style.html+""!="1"&&(n=mxUtils.htmlEntities(n,!1)),n},t.convertValueToString=function(t){return Ext.isString(t.value)?t.value:Ext.isEmpty(t.getAttribute("objectCode"))?t.getAttribute("label"):e.generateObjHtml(t)};var n=t.removeCells;t.removeCells=function(e,i){e||(e=t.getDeletableCells(t.getSelectionCells()));for(var a=e.length-1;a>-1;)e[a].getAttribute("srcProp")&&e.splice(a,1),a--;n.call(t,e,i)}},generateObjHtml:function(e){var t,n,i,a,o,r=this;n=e.getAttribute("objectCode"),r.htmCache||(r.htmCache={}),i=['<table width="100%" height="100%" style=" -moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;" >','<tr><td style="vertical-align: top;" ><div  >','<table style="width:100%;" >','<tr><td colspan="2" style="text-align:center; background:#C1D3F5;padding:2px;">',n,"</td></tr>"],(t=$App.domainInfo.get(n)).eachAttribute(function(e,t){if(Ext.String.startsWith(t,"mi_",!0))return!0;a="Entity"===e.dataType,o="Enum"===e.dataType?"Enum "+e.enumGroup:a?"<B>"+e.associatedEntity+"</B>":e.dataType,i.push("<tr><td>",t,'</td><td style="padding:2px;">',o,"</td></tr>")});var l=[];return _.forEach(t.mixins,function(e,t){e.enabled&&l.push(UBE.UBMetaDiagram.mixinPictures[t]||t)}),l.length&&i.push('<tr><td colspan="2" style="text-align:center; background:#C1D3F5;padding:2px;">'+l.join("&nbsp")+"</td></tr>"),i.push("</table></div></td></tr></table>"),i.join("")},getMixinShortName:function(e){return"mStorage"===e?"S":e.substr(0,1).toUpperCase()},refreshTasks:function(e){var t=this;null!==this.tasks&&(t.taskEl.innerHTML="",t.taskEl.createTasks(e))},showTasks:function(){var e,t,n=this,i=n.editor.graph;if(null===n.editor.tasks){var a=document.createElement("div");a.style.padding="4px",a.style.paddingLeft="20px",t=Ext.widget("panel",{border:!0,flex:1}),e=Ext.create("Ext.Window",{title:"Tasks",width:200,height:400,closable:!0,closeAction:"hide",autoDestroy:!1,layout:"fit",items:[t]}).show(),n.taskWnd=e,e.ownerCt=n,e.registerWithOwnerCt();var o=t.getEl().dom;document.getElementById(o.id+"-innerCt").appendChild(a),n.taskEl=a;var r=mxUtils.bind(n,function(){n.taskEl.innerHTML="",n.editor.createTasks(n.taskEl)});i.getModel().addListener(mxEvent.CHANGE,r),i.getSelectionModel().addListener(mxEvent.CHANGE,r),i.addListener(mxEvent.ROOT,r),n.editor.tasks=e,n.editor.createTasks(a)}n.taskWnd.show()},showProperties:function(e){var t=this,n=t.editor;if(null===(e=e||n.graph.getSelectionCell())&&null===(e=n.graph.getCurrentRoot())&&(e=n.graph.getModel().getRoot()),null!==e){n.graph.stopEditing(!0),n.hideProperties();var i=n.createProperties(e);if(null!==i){var a=Ext.widget("panel",{border:!0,flex:1}),o=Ext.create("Ext.Window",{title:"Properties",width:250,height:400,closable:!1,layout:"fit",items:[a]}).show();o.ownerCt=t,o.registerWithOwnerCt();var r=a.getEl().dom;document.getElementById(r.id+"-innerCt").appendChild(i),n.properties=o}}},hideProperties:function(){var e=this.editor;null!==e.properties&&(e.properties.close(),e.properties=null)},beforeDestroy:function(){var e=this;e.editor&&e.editor.destroy(),e.tasksWnd&&e.tasksWnd.destroy(),e.editEntityFrmEditor=null,e.editEntityFrm&&e.editEntityFrm.destroy(),Ext.EventManager.un(document,"onmouseup",e.onmouseUpFunc,e),Ext.EventManager.un(document,"onmousemove",e.onmousemoveFunc,e),e.callParent(arguments)},actionHandler:function(e){this.editor.execute(e.mxAction)},getValue:function(){var e=this,t=(new mxCodec).encode(e.editor.graph.getModel());return mxUtils.getXml(t)},resetOriginalValue:function(){return null}}),window.mxBasePath="models/UBE/mxGraph/src",UB.ux.UBDocument.editors.ubDiagram="UBE.UBMetaDiagram",UB.ux.UBDocument.contentTypeMapping["application/ubMetaDiagram"]="UBE.UBMetaDiagram",UB.ux.UBDocument.contentTypeMapping["application/ubmetadiagram"]="UBE.UBMetaDiagram",Ext.define("UBE.UBOrgChart",{extend:"Ext.Panel",alias:"widget.UBOrgChart",width:"100%",height:"100%",layout:"fit",loadData:function(e){var t,n,i=this;(t=i.up("basepanel"))&&t.record&&(n=t.record.get("ID")),n&&i.loadBy("org_diagram",["ID","orgunitID"],"ID",n,function(t){t.getCount()>0&&(i.rootElementID=t.getAt(0).get("orgunitID")),i.rootElementID?i.loadBy("org_unit",["ID","mi_treePath"],"ID",i.rootElementID,function(t){t.getCount()>0&&(i.rootTreePath=t.getAt(0).get("mi_treePath")),i.doLoadData(e)}):i.doLoadData(e)})},doLoadData:function(e){var t,n=this;t=[{entity:"org_unit",requestName:"org_unit",method:"select",fieldList:["ID","parentID","code","caption","unitType","mi_treePath"],orderList:{orderByID:{expression:"mi_treePath",order:"asc"}}}],n.rootTreePath&&(t[0].whereList={byTree:{expression:"[mi_treePath]",condition:"startWith",values:{mi_treePath:n.rootTreePath}}}),UB.core.UBDataLoader.loadStores({ubRequests:t,setStoreId:!0,callback:function(t){n.makeTree(t.org_unit),e.call(n)},scope:this})},treeData:[],makeTree:function(e){var t,n,i,a,o,r=this,l={};r.treeData=[],o=function(e,t){t.ID=e.get("ID"),t.parentID=e.get("parentID"),t.caption=e.get("caption"),t.code=e.get("code"),t.unitType=e.get("unitType")},e.each(function(e){t=e.get("ID"),n=e.get("parentID"),(a=l[t])||(a=l[t]={child:[]}),o(e,a),r.rootElementID&&r.rootElementID===t&&(n=null,a.parentID=null),n?((i=l[n])||(i=l[n]={child:[]}),i.child.push(a)):r.treeData.push(a)},r),r.allData=l},showElement:function(e,t,n){var i=this;return i.addChild(i.graph,e,t,!0,n)},showChild:function(e,t,n,i,a){var o,r,l=this;n||(r=l.graph.getModel()).beginUpdate();try{Ext.Array.each(t.child,function(t,r){o=l.showElement(e,t),n&&(!i||i>a)&&l.showChild(o,t,i,a+1)},l)}finally{n||r.endUpdate()}},defaultLayout:"V",showTree:function(){var e,t=this,n=t.graph.getModel();1===t.treeData.length?t.addChild(t.graph,null,t.treeData[0]):t.initRoot(t.treeData),n.beginUpdate();try{1===t.treeData.length?t.showChild(t.rootVarex,!0,!0,2,1):Ext.Array.each(t.treeData,function(n,i){e=t.showElement(t.rootVarex,n)},t)}finally{n.endUpdate()}t.autoLayout(t.rootVarex,t.defaultLayout),t.setGraphVisiblePoint(t.rootVarex.geometry.x,t.rootVarex.geometry.y),t.changeFired=!1,t.undoManager.clear()},setGraphVisiblePoint:function(e,t){},initComponent:function(){var e,t,n,i=this;i.layout="fit",i.initMetaInfo(),i.tbar=i.createToolBar(),i.idPrefix=Ext.id(),i.containerId=e=i.idPrefix+"graph",t='<div id="'+e+'" class="graph-editor-holder" style="width: 100%; height: 100%; background-color: white; overflow: scroll; -moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;" tabindex="0"></div>',i.outlineId=e=i.idPrefix+"outline",n='<div id="'+e+'" style="width: 100%; height: 100%; overflow: scroll;" ></div>',i.outlineWnd=Ext.create("Ext.Window",{title:"Overview",width:200,height:200,closable:!1,layout:"fit",constrain:!0,items:[{html:n}]}),i.mainPnl=Ext.create("Ext.panel.Panel",{flex:1,html:t,items:[i.outlineWnd,{xtype:"text",text:"text",degrees:90}],listeners:{boxready:function(e){UB.inject(window.mxBasePath+"/js/mxClient.js").then(function(){return UB.inject(window.mxBasePath+"/js/graphEditor/Shapes.js")}).done(function(){i.initGraph()})},resize:function(e,t,n,a,o){i.graph&&i.graph.sizeDidChange()},scope:i}}),i.items||(i.items=[]),i.items.push(i.mainPnl),i.callParent(arguments),i.isLoadContent=!1},beforeDestroy:function(){var e=this;e.outlineWnd&&e.outlineWnd.destroy(),e.toolbarWnd&&e.toolbarWnd.destroy(),e.rubberband&&e.rubberband.destroy(),e.keyHandler&&e.keyHandler.destroy(),e.toolbar&&e.toolbar.destroy(),e.outline&&e.outline.destroy(),e.graph&&e.graph.destroy(),e.callParent(arguments)},initGraph:function(){var e,t,n,i,a,o,r,l=this;l.graphDivEl=Ext.get(l.containerId),(o=l.up("basewindow"))||(o=$App.getViewport()),r=o.getEl().dom.style.zIndex||1,(e=l.graphDivEl.dom).style.position="absolute",e.style.overflow="hidden",e.style.left="0px",e.style.top="0px",e.style.right="0px",e.style.bottom="0px";var d=l.mainPnl.getBox();l.outlineWnd.showAt(d.width-l.outlineWnd.width,0),l.outlineWnd.setXY([d.right-l.outlineWnd.width,d.top]),n=document.getElementById(l.outlineId),mxEvent.disableContextMenu(e),new mxDivResizer(e),new mxDivResizer(n),l.graph=t=new mxGraph(e),t.setCellsMovable(!0),t.setAutoSizeCells(!0),t.setPanning(!0),t.setTooltips(!0),t.centerZoom=!1,t.panningHandler.useLeftButtonForPanning=!0,t.panningHandler.selectOnPopup=!1,t.panningHandler.panningEnabled=!0,t.cellsDisconnectable=!1,t.cellsCloneable=!1,t.allowDanglingEdges=!1,t.disconnectOnMove=!1,t.gridEnabled=!1,l.isGraphChanged=!1,t.getModel().addListener(mxEvent.CHANGE,function(){l.graphChanged()}),l.installDblClickHandler(t),l.rubberband=new mxRubberband(t),l.outline=new mxOutline(t,n),t.setTooltips(!mxClient.IS_TOUCH),t.tooltipHandler.zIndex=r+100,l.undoManager=new mxUndoManager,l.installUndoHandler(t),t.setHtmlLabels(!0),(i=t.getStylesheet().getDefaultVertexStyle())[mxConstants.STYLE_SHAPE]="label",i[mxConstants.STYLE_WHITE_SPACE]="wrap",i[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_MIDDLE,i[mxConstants.STYLE_ALIGN]=mxConstants.ALIGN_LEFT,i[mxConstants.STYLE_SPACING_LEFT]=4,i[mxConstants.STYLE_GRADIENTCOLOR]="#7d85df",i[mxConstants.STYLE_STROKECOLOR]="#5d65df",i[mxConstants.STYLE_FILLCOLOR]="#adc5ff",i[mxConstants.STYLE_FONTCOLOR]="#1d258f",i[mxConstants.STYLE_FONTFAMILY]="Verdana",i[mxConstants.STYLE_FONTSIZE]="10",i[mxConstants.STYLE_FONTSTYLE]="1",i[mxConstants.STYLE_SHADOW]="1",i[mxConstants.STYLE_ROUNDED]="1",i[mxConstants.STYLE_GLASS]="1",i[mxConstants.STYLE_SPACING]=12,(i=Ext.clone(i))[mxConstants.STYLE_GRADIENTCOLOR]="#7DDF94",i[mxConstants.STYLE_STROKECOLOR]="#5DDF71",i[mxConstants.STYLE_FILLCOLOR]="#ADFFBD",t.getStylesheet().putCellStyle("org_staffunit",i),(i=Ext.clone(i))[mxConstants.STYLE_GRADIENTCOLOR]="#D5DF7D",i[mxConstants.STYLE_STROKECOLOR]="#D2DF5D",i[mxConstants.STYLE_FILLCOLOR]="#F7FFAD",t.getStylesheet().putCellStyle("org_department",i),(i=Ext.clone(i))[mxConstants.STYLE_GRADIENTCOLOR]="#7d85df",i[mxConstants.STYLE_STROKECOLOR]="#5d65df",i[mxConstants.STYLE_FILLCOLOR]="#adc5ff",t.getStylesheet().putCellStyle("org_organization",i),(i=t.getStylesheet().getDefaultEdgeStyle())[mxConstants.STYLE_ROUNDED]=!0,i[mxConstants.STYLE_STROKEWIDTH]=3,i[mxConstants.STYLE_EDGE]=mxEdgeStyle.OrthConnector,l.keyHandler=new mxKeyHandler(t),(a=new mxCompactTreeLayout(t,!1)).useBoundingBox=!1,a.edgeRouting=!1,a.levelDistance=60,a.nodeDistance=16,a.isVertexMovable=function(e){return!0},l.verticalLayout=a,(a=new mxCompactTreeLayout(t,!0)).useBoundingBox=!1,a.edgeRouting=!1,a.levelDistance=60,a.nodeDistance=16,a.isVertexMovable=function(e){return!0},l.horisontalLayout=a,t.popupMenuHandler.factoryMethod=function(e,n,i){var a=o.getEl().dom,r=a.style.zIndex||9999999999999;return e.div.parent=a,e.zIndex=r+1,e.div.style.zIndex=r+1,l.createPopupMenu(t,e,n,i)};var s=t.getPreferredSizeForCell;t.getPreferredSizeForCell=function(e){var t=s.apply(this,arguments);return null!==t&&(t.width=Math.max(120,t.width-40)),t},t.cellRenderer.getTextScale=function(e){return Math.min(1,e.view.scale)},t.convertValueToString=function(e){return Ext.isString(e.value)?e.value:e.getAttribute("label")},t.getPreferredSizeForCell=Ext.bind(l.getPreferredSizeForCell,t),l.graph&&l.dataUrl&&!l.isActulData&&l.startLoadData().done(function(e){l.loadDataDefer&&l.loadDataDefer.resolve(e)},function(e){l.loadDataDefer.reject(e)})},installUndoHandler:function(e){var t=mxUtils.bind(this,function(e,t){var n=t.getProperty("edit");this.undoManager.undoableEditHappened(n)});e.getModel().addListener(mxEvent.UNDO,t),e.getView().addListener(mxEvent.UNDO,t);var n=function(t,n){var i=n.getProperty("edit").changes;e.setSelectionCells(e.getSelectionCellsForChanges(i))};this.undoManager.addListener(mxEvent.UNDO,n),this.undoManager.addListener(mxEvent.REDO,n)},initRoot:function(){var e,t,n,i,a=this,o=a.graph;e=o.getDefaultParent(),o.getModel().beginUpdate();try{(i=mxUtils.createXmlDocument().createElement("ubOrgChart")).setAttribute("label","Organization"),i.setAttribute("unitType","ORG"),i.setAttribute("isRoot",!0),t=o.container.offsetWidth,n=o.insertVertex(e,"treeRoot",i,t/2-30,20,140,60,"image="+$App.getImagePath("office.png")),o.updateCellSize(n),a.addExpandOverlay(o,n,!0),a.addIconOverlay(n),n.isRoot=!0,a.rootVarex=n}finally{o.getModel().endUpdate()}},installDblClickHandler:function(e){e.addListener(mxEvent.DOUBLE_CLICK,mxUtils.bind(this,function(t,n){var i=n.getProperty("cell");i&&e.isEnabled()&&null!==this.dblClickAction&&(this.dblClickAction(i,n),e.tooltipHandler.hide(),n.consume())}))},dblClickAction:function(e,t){var n,i=this,a=e.getAttribute("unitType"),o=e.getAttribute("ID");(n=i.getEntityByUnitType(a))&&o&&i.openForm(n,o,null,function(e){i.refreshDiagram()})},getEntityByUnitType:function(e){var t=this.orgUnity[e];return t?t.code:""},openForm:function(e,t,n,i){this.openFormC({entityCode:e,instanceID:t,initialFieldValues:n,onClose:i})},openFormC:function(e){var t,n,i,a,o=this,r=UB.core.UBAppConfig.systemEntities;$App.domainInfo.get(e.entityCode).hasMixin("dataHistory"),e.isModal=!!Ext.isEmpty(e.isModal)||e.isModal,(t=UB.core.UBFormLoader.getFormByEntity(e.entityCode))&&(n=t.get(r.form.fields.code),i=UB.i18n(t.get(r.form.fields.description))),a={cmdType:UB.core.UBCommand.commandType.showForm,formCode:n,description:i,entity:e.entityCode,instanceID:e.instanceID,initialFieldValues:e.initialFieldValues,customParams:e.customParams,isModal:e.isModal,callback:function(t){if(e.onClose&&t){var n=t.up("window");n&&n.on({beforeclose:e.onClose,scope:o})}}},UB.core.UBApp.doCommand(a)},createToolBar:function(){var e=this;return Ext.define("SelectPrinterFmt",{extend:"Ext.data.Model",fields:[{name:"ID",type:"object"},{name:"Caption",type:"string"}]}),{xtype:"toolbar",items:[{xtype:"button",text:UB.i18n("Undo"),iconCls:"icon-undo",handler:function(){e.undoManager.undo()},scope:e},{xtype:"button",text:UB.i18n("Redo"),iconCls:"icon-redo",handler:function(){e.undoManager.redo()},scope:e},{xtype:"button",text:UB.i18n("Zoom"),iconCls:"icon-zoom-in",handler:function(){e.graph.zoomIn()},scope:e},{xtype:"button",text:UB.i18n("Zoom Out"),iconCls:"icon-zoom-out",handler:function(){e.graph.zoomOut()},scope:e},{xtype:"button",text:UB.i18n("Actual Size"),iconCls:"icon-view11",handler:function(){e.graph.zoomActual()},scope:e},{xtype:"combobox",store:Ext.create("Ext.data.Store",{model:"SelectPrinterFmt",data:[{ID:"A4P",Caption:"A4 portrait"},{ID:"A4L",Caption:"A4 landscape"},{ID:"A5P",Caption:"A5 portrait"},{ID:"A5L",Caption:"A5 landscape"}]}),forceSelection:!0,editable:!1,allowBlank:!1,displayField:"Caption",valueField:"Caption",value:"A4 portrait",width:100,labelWidth:0,queryMode:"local",listeners:{select:function(t,n){if(n.length>0)switch(n[0].get("ID")){case"A4P":e.printerFormat=mxConstants.PAGE_FORMAT_A4_PORTRAIT;break;case"A4L":e.printerFormat=mxConstants.PAGE_FORMAT_A4_LANDSCAPE;break;case"A5P":e.printerFormat=new mxRectangle(0,0,1652,1169);break;case"A5L":e.printerFormat=new mxRectangle(0,0,1169,1652)}},scope:e}},{xtype:"button",text:UB.i18n("Print"),iconCls:"icon-printer",handler:function(){new mxPrintPreview(e.graph,1,e.printerFormat||null).open()},scope:e},{xtype:"button",text:UB.i18n("Poster Print"),iconCls:"icon-print",handler:function(){Ext.Msg.prompt({msg:UB.i18n("Enter maximum page count"),prompt:!0,title:"",minWidth:Ext.Msg.minPromptWidth,buttons:Ext.Msg.OKCANCEL,callback:function(t,n){if("ok"===t){var i=n;if(null!==i){var a=mxUtils.getScaleForPageCount(i,e.graph);new mxPrintPreview(e.graph,a,e.printerFormat||null).open()}}},scope:e,multiline:!1,value:"1"})},scope:e},{xtype:"button",text:UB.i18n("Select"),icon:window.mxBasePath+"/resources/images/select.gif",handler:function(){e.graph.panningHandler.useLeftButtonForPanning=!1,e.graph.setConnectable(!1)},scope:e},{xtype:"button",text:UB.i18n("Pan"),icon:window.mxBasePath+"/resources/images/pan.gif",handler:function(){e.graph.panningHandler.useLeftButtonForPanning=!0,e.graph.setConnectable(!1)},scope:e},{xtype:"button",text:UB.i18n("Select all"),handler:function(){e.graph.selectAll()},scope:e}]}},createPopupMenu:function(e,t,n,i){var a=this,o=e.getModel();if(a.isLoadContent||t.addItem(UB.i18n("New organizational chart"),"",function(){a.loadData(function(){a.showTree(),a.isLoadContent=!0})}),null!==n){if(o.isVertex(n))Ext.Object.each(a.orgUnity,function(e,i){t.addItem(UB.i18n("Create child")+" "+i.caption,"",function(){a.createChildElement(n,e)})},a),t.addSeparator(),t.addItem(UB.i18n("Open subordinate chart from this node"),"",function(){a.openDiagram(n)}),t.addSeparator(),t.addItem(UB.i18n("Remove all child"),"",function(){a.deleteSubtree(e,n),a.graph.removeCellOverlays(n),a.addIconOverlay(n),a.addAddOverlay(a.graph,n)}),t.addItem(UB.i18n("Select all child"),"",function(){a.selectAllChild(n)}),t.addSeparator(),t.addItem(UB.i18n("Align child to right"),"",function(){a.autoLayout(n,"H"),a.selectAllChild(n),a.setGraphVisiblePoint(n.geometry.x,n.geometry.y)}),t.addItem(UB.i18n("Align child down me"),"",function(){a.autoLayout(n,"V"),a.selectAllChild(n),a.setGraphVisiblePoint(n.geometry.x,n.geometry.y)});else{var r=n.getStyle()||"edgeStyle=orthogonalEdgeStyle;";r.indexOf("topToBottomEdgeStyle")<0&&t.addItem(UB.i18n("Format edge top to bottom"),"",function(){e.setCellStyle("edgeStyle=topToBottomEdgeStyle;",[n])}),r.indexOf("sideToSideEdgeStyle")<0&&t.addItem(UB.i18n("Format edge left to right"),"",function(){e.setCellStyle("edgeStyle=sideToSideEdgeStyle;",[n])}),r.indexOf("orthogonalEdgeStyle")<0&&t.addItem(UB.i18n("Format edge orthogonal"),"",function(){e.setCellStyle("edgeStyle=orthogonalEdgeStyle;",[n])})}t.addSeparator()}t.addItem("Fit",$App.getImagePath("zoom_in.png"),function(){e.fit()}),t.addItem("Actual",$App.getImagePath("view_1_1.png"),function(){e.zoomActual()}),t.addSeparator(),t.addItem("Print",$App.getImagePath("print.png"),function(){new mxPrintPreview(e,1).open()}),t.addItem("Poster Print",$App.getImagePath("print.png"),function(){var t=mxUtils.prompt("Enter maximum page count","1");if(null!==t){var n=mxUtils.getScaleForPageCount(t,e);new mxPrintPreview(e,n).open()}})},setDetaileEdgeStyle:function(e,t){var n,i=this,a=[],o=i.graph.model;i.graph.traverse(e,!0,function(e){if((n=o.getEdgeCount(e))>0)for(var t=0;t<n;t++){var i=o.getEdgeAt(e,t);o.getTerminal(i,!0)===e&&a.push(i)}return!0}),i.graph.setCellStyle("edgeStyle="+t+";",a)},autoLayout:function(e,t){var n=this;switch(t){case"H":n.setDetaileEdgeStyle(e,"sideToSideEdgeStyle"),n.horisontalLayout.execute(n.graph.getDefaultParent(),e);break;case"V":n.setDetaileEdgeStyle(e,"topToBottomEdgeStyle"),n.verticalLayout.execute(n.graph.getDefaultParent(),e)}},expandImage:$App.getImagePath("expandLG.png"),collapseImage:$App.getImagePath("collapseLG.png"),appendImage:$App.getImagePath("download.png"),addExpandOverlay:function(e,t,n){var i=this,a=new mxCellOverlay(new mxImage(n?i.collapseImage:i.expandImage,24,24),"Expande");a.cursor="hand",a.align=mxConstants.ALIGN_CENTER,a.addListener(mxEvent.CLICK,mxUtils.bind(this,function(e,n){i.expandORCollapse(t,a)})),a.isExpandOvelay=!0,a.expanded=!n,e.addCellOverlay(t,a)},addAddOverlay:function(e,t){var n,i=this;(n=new mxCellOverlay(new mxImage(i.appendImage,24,24),"Append element")).cursor="hand",n.offset=new mxPoint(-4,8),n.align=mxConstants.ALIGN_RIGHT,n.verticalAlign=mxConstants.ALIGN_TOP,n.addListener(mxEvent.CLICK,mxUtils.bind(this,function(e,a){i.addChildElement(t,n)})),n.isAddOverlay=!0,e.addCellOverlay(t,n)},addIconOverlay:function(e){var t,n,i,a,o,r=this;t=e.getAttribute("unitType"),a=e.getAttribute("label"),i=(o=r.orgUnity[t])?o.image:$App.getImagePath("office.png"),(n=new mxCellOverlay(new mxImage(i,24,24),a)).offset=new mxPoint(4,8),n.align=mxConstants.ALIGN_LEFT,n.verticalAlign=mxConstants.ALIGN_TOP,n.isIconOverlay=!0,r.graph.addCellOverlay(e,n)},updateCell:function(e){this.graph.refresh(e)},getAddOvelay:function(e){var t=this,n=null;return e.overlays&&0!==e.overlays.length?(Ext.Array.each(e.overlays,function(e){if(e.isAddOverlay)return n=e,!1},t),n):null},getExpandOvelay:function(e){var t=this,n=null;return e.overlays&&0!==e.overlays.length?(Ext.Array.each(e.overlays,function(e){if(e.isExpandOvelay)return n=e,!1},t),n):null},addChildElement:function(e,t){var n,i,a,o,r=this,l=e.getAttribute("ID"),d=r.allData[l],s=r.graph.getModel(),c={},u=0,g=[];if(i=r.findChildCell(e),Ext.Array.each(i,function(e){a=e.getAttribute("ID"),c[1*a]=e,u++}),d.child.length>0){s.beginUpdate();try{o={x:e.geometry.x,y:e.geometry.y+120},Ext.Array.each(d.child,function(t){c[t.ID]||(r.showElement(e,t,o),g.push(e),o.x+=100)})}finally{s.endUpdate()}0===u&&r.autoLayout(e,r.defaultLayout),r.graph.removeCellOverlay(e,t),(n=r.getExpandOvelay(e))?n.expanded&&r.expandORCollapse(e):r.addExpandOverlay(r.graph,e,!0),0===u?r.selectAllChild(e):r.graph.setSelectionCells(g)}},expandORCollapse:function(e,t){var n,i=this,a=e.getAttribute("ID"),o=i.allData[a];o&&(n=o.child),e.isRoot&&!a&&(n=i.treeData),n.length>0&&(i.hideOrShowCells(i.graph,e,t.expanded),t.expanded=!t.expanded,t.image.src=t.expanded?i.expandImage:i.collapseImage),i.updateCell(e)},hideOrShowCells:function(e,t,n){var i,a=this,o=[],r=!1;return e.traverse(t,!0,function(e){return t!==e&&(o.push(e),r=r||!e.isVisible()),!0}),null===n&&(n=r),e.toggleCells(n,o,!0),n&&Ext.Array.each(o,function(e){(i=a.getExpandOvelay(e))&&i.expanded&&(i.image.src=a.collapseImage,a.updateCell(e))}),n},changeElementParent:function(e,t,n){var i,a,o=this,r=o.graph.getModel();if((i=r.getEdgeCount(e))>0)for(var l=0;l<i;l++)if(a=r.getEdgeAt(e,l),r.getTerminal(a,!0)!==e){o.graph.cellsRemoved([a]);break}o.addElementEdge(e,t,n)},addChild:function(e,t,n,i,a){var o,r,l,d,s=this,c=e.getModel(),u=e.getDefaultParent();i||c.beginUpdate();try{(o=mxUtils.createXmlDocument().createElement("ubOrgChart")).setAttribute("label",n.caption),o.setAttribute("ID",n.ID),o.setAttribute("parentID",n.parentID),o.setAttribute("code",n.code),o.setAttribute("unitType",n.unitType),t||o.setAttribute("isRoot",!0),a&&(r=a.x,l=a.y),(d=e.insertVertex(u,null,o,r,l)).setStyle(s.getEntityByUnitType(n.unitType));var g=c.getGeometry(d),p=e.getPreferredSizeForCell(d);g.width=p.width,g.height=p.height,t?s.addElementEdge(d,t,n):(d.isRoot=!0,s.rootVarex=d),n.child.length>0&&s.addAddOverlay(e,d),s.addIconOverlay(d)}finally{i||c.endUpdate()}return d},addElementEdge:function(e,t,n){var i=this.graph,a=i.getDefaultParent(),o=i.insertEdge(a,null,"",t,e);o.setAttribute("fromID",n.ID),o.fromID=n.ID,o.setGeometry(new mxGeometry(0,0,0,0)),o.geometry.relative=!0,o.geometry.setTerminalPoint(new mxPoint(0,0),!0),o.geometry.setTerminalPoint(new mxPoint(80,0),!0),o.geometry.setTerminalPoint(new mxPoint(160,0),!1)},selectAllChild:function(e){var t=this,n=[];t.graph.traverse(e,!0,function(t){return e!==t&&n.push(t),!0}),t.graph.setSelectionCells(n)},deleteSubtree:function(e,t){var n=[];e.traverse(t,!0,function(e){return t!==e&&n.push(e),!0}),e.removeCells(n)},getPreferredSizeForCell:function(e){var t=null;if(null!==e){var n=this.view.getState(e),i=n?n.style:this.getCellStyle(e);if(null!==i&&!this.model.isEdge(e)){var a=i[mxConstants.STYLE_FONTSIZE]||mxConstants.DEFAULT_FONTSIZE,o=0,r=0;(this.getImage(n)||i[mxConstants.STYLE_IMAGE])&&i[mxConstants.STYLE_SHAPE]===mxConstants.SHAPE_LABEL&&(i[mxConstants.STYLE_VERTICAL_ALIGN]===mxConstants.ALIGN_MIDDLE&&(o+=parseFloat(i[mxConstants.STYLE_IMAGE_WIDTH])||mxLabel.prototype.imageSize),i[mxConstants.STYLE_ALIGN]!==mxConstants.ALIGN_CENTER&&(r+=parseFloat(i[mxConstants.STYLE_IMAGE_HEIGHT])||mxLabel.prototype.imageSize)),o+=2*(i[mxConstants.STYLE_SPACING]||0),o+=i[mxConstants.STYLE_SPACING_LEFT]||0,o+=i[mxConstants.STYLE_SPACING_RIGHT]||0,r+=2*(i[mxConstants.STYLE_SPACING]||0),r+=i[mxConstants.STYLE_SPACING_TOP]||0,r+=i[mxConstants.STYLE_SPACING_BOTTOM]||0;var l=this.getFoldingImage(n);null!==l&&(o+=l.width+8);var d=this.getLabel(e);if(d&&d.length>0){this.isHtmlLabel(e)||(d=d.replace(/\n/g,"<br>"));var s=mxUtils.getSizeForString(d,a,i[mxConstants.STYLE_FONTFAMILY]);s.width+o>100&&(s=mxUtils.getSizeForString(d,a,i[mxConstants.STYLE_FONTFAMILY],100));var c=s.width+o,u=s.height+r;if(!mxUtils.getValue(i,mxConstants.STYLE_HORIZONTAL,!0)){var g=u;u=c,c=g}this.gridEnabled&&(c=this.snap(c+this.gridSize/2),u=this.snap(u+this.gridSize/2)),t=new mxRectangle(0,0,c,u)}else{var p=4*this.gridSize;t=new mxRectangle(0,0,p,p)}}}return t},getValue:function(){var e=this,t=(new mxCodec).encode(e.graph.getModel());return mxUtils.getXml(t)},resetOriginalValue:function(){return this.changeFired=!1,this.isGraphChanged=!1,null},graphChanged:function(){var e=this;e.isLoadComlete&&(e.isGraphChanged=!0,e.changeFired||this.fireEvent("change",this,!0),e.changeFired=!0)},isDirty:function(){return this.isGraphChanged},updateDataBlob:function(e){var t=this;t.useBlobForData||Ext.Error.raise("object does not use Blob"),t.dataBlob&&!Ext.isEmpty(this.objUrl)&&window.URL.revokeObjectURL(this.objUrl),t.data=null,t.dataBlob=e,t.objUrl=window.URL.createObjectURL(e),t.data=t.objUrl},onDestroy:function(){var e=this;e.dataBlob=null,e.data=null,e.useBlobForData&&!Ext.isEmpty(e.objUrl)&&window.URL.revokeObjectURL(e.objUrl),e.objUrl=null,this.callParent()},setSrc:function(e){var t,n=this,i=e.url,a=e.blobData;if(e.rawValue)throw new Error("The UBOrgChart component does not support rawValue");return n.dataUrl=i,n.useBlobForData&&a&&n.updateDataBlob(a),n.isActulData=!1,n.changeFired=!0,n.graph?t=n.startLoadData():(n.loadDataDefer=Q.defer(),t=n.loadDataDefer.promise),n.changeFired=!1,t},startLoadData:function(){var e,t,n,i=this,a=Q.defer();if(i.dataUrl&&i.graph)return i.isLoadComlete=!1,i.getEl().mask(UB.i18n("loadingData")),$App.connection.get(i.dataUrl).then(function(a){if("string"==typeof(t=a.data)){var o=new DOMParser;if(t=o.parseFromString(t,"application/xml"),(n=t.getElementsByTagName("parsererror")).length>0)throw new Error(n[0].innerHTML)}return(e=new mxCodec(t.documentElement.ownerDocument)).decode(t.documentElement,i.graph.getModel()),this.baseUrl=i.dataUrl,i.isLoadComlete=!0,i.isLoadContent=!0,i.isGraphChanged=!1,i.undoManager.clear(),i.isActulData=!0,!0}).done(function(){try{i.loadData(function(){try{i.validateDiagram(),a.resolve()}finally{i.getEl().unmask()}})}catch(e){throw i.getEl().unmask(),a.reject(e),e}},function(e){a.reject(e),i.getEl().unmask()}),a.promise},initNewSrc:function(){var e=this;return e.loadData(function(){e.showTree(),e.isLoadContent=!0,e.isLoadComlete=!0}),null},findParentCell:function(e){var t,n,i,a=this.graph.getModel();if((t=a.getEdgeCount(e))>0)for(var o=0;o<t;o++)if(n=a.getEdgeAt(e,o),(i=a.getTerminal(n,!0))!==e)return i;return null},findChildCell:function(e){var t,n,i,a=this.graph.getModel(),o=[];if((t=a.getEdgeCount(e))>0)for(var r=0;r<t;r++)n=a.getEdgeAt(e,r),(i=a.getTerminal(n,!1))!==e&&o.push(i);return o},refreshDiagram:function(e){var t=this;t.loadData(function(){t.validateDiagram(!0),e&&e.call(t)})},validateDiagram:function(e){var t,n,i,a,o,r,l=this,d=l.graph.getModel(),s=!1,c=[],u=[],g={};l.rootVarex=null,Ext.Object.each(d.cells,function(e,d){if(d.vertex){if((t=d.getAttribute("ID"))&&(t*=1),(n=d.getAttribute("isRoot"))&&(l.rootVarex=d,d.isRoot=!0),!t)return!0;i=l.findParentCell(d),(a=i?i.getAttribute("ID")||null:null)&&(a*=1),s=!0,(o=l.allData[t])?(d.getAttribute("label")!==o.caption&&d.setAttribute("label",o.caption),d.getAttribute("code")!==o.code&&d.setAttribute("code",o.code),d.getAttribute("unitType")!==o.unitType&&d.setAttribute("unitType",o.unitType),o.parentID!==a&&u.push(d),(r=g[t])?r.cell=d:g[t]=r={cell:d,child:[]},(r=g[o.parentID||"root"])?r.child.push(d):g[o.parentID||"root"]=r={child:[d]}):c.push(d)}}),Ext.Array.each(u,function(e){(t=e.getAttribute("ID"))&&(t*=1),o=l.allData[t],(r=g[o.parentID])?l.changeElementParent(e,r.cell,o):c.push(e)},l),l.graph.removeCells(c,!0),Ext.Object.each(g,function(t,n){if("root"===t)return l.updateCellOverlay(l.rootVarex,n.child,l.treeData.length,e),!0;(r=l.allData[t])&&l.updateCellOverlay(n.cell,n.child,r.child.length,e)},l),l.undoManager.clear(),l.rootVarex?(l.changeFired=!1,l.isGraphChanged=!1,l.isLoadComlete=!0):Ext.Msg.alert("","Root is not found")},updateCellOverlay:function(e,t,n,i){var a,o=this,r=!1;Ext.Array.each(t,function(e){if(e.isVisible())return r=!0,!1},o),i?(a=o.getAddOvelay(e),t.length===n||a||o.addAddOverlay(o.graph,e),0===n&&a&&o.graph.removeCellOverlay(e,a),a=o.getExpandOvelay(e),0===t.length&&a&&o.graph.removeCellOverlay(e,a)):(t.length!==n&&o.addAddOverlay(o.graph,e),n>0&&t.length>0&&o.addExpandOverlay(o.graph,e,r),o.addIconOverlay(e))},createNewDiagram:function(e,t,n){var i=this;UB.core.UBService.runList([{entity:"org_diagram",method:UB.core.UBCommand.methodName.ADDNEW,fieldList:["ID"],execParams:{}}],function(a){var o,r,l;a&&(o=UB.core.UBUtil.getByPropertyValue(a,"entity","org_diagram"))&&(r=o.resultData,l=r.data[0][0],UB.core.UBService.runList([{fieldList:["ID","orgunitID","caption"],entity:"org_diagram",method:UB.core.UBCommand.methodName.INSERT,execParams:{ID:l,orgunitID:e,caption:t}}],function(e){e.serverFailure||n.call(i,l)},i))},i)},openDiagram:function(e){var t,n,i,a=this;t=1*e.getAttribute("ID"),n=e.getAttribute("label"),a.loadBy("org_diagram",["ID","orgunitID","caption"],"orgunitID",t,function(e){0===e.getCount()?Ext.Msg.show({msg:UB.i18n("Chart for this item does not exist. Create a new one?"),prompt:!1,title:"",minWidth:Ext.Msg.minPromptWidth,buttons:Ext.Msg.OKCANCEL,callback:function(e,o){"ok"===e&&a.createNewDiagram(t,n,function(e){i=e,this.openFormC({entityCode:"org_diagram",instanceID:i,isModal:!1})})},scope:a,multiline:!1}):(i=e.getAt(0).get("ID"),this.openFormC({entityCode:"org_diagram",instanceID:i,isModal:!1}))})},createChildElement:function(e,t){var n,i,a=this;n=a.getEntityByUnitType(t),i=(i=e.getAttribute("ID"))?1*i:null,n&&a.openForm(n,null,{parentID:i},function(t){var n=t.down("basepanel");n&&n.record&&a.checkElementId(n.record.get("ID"),e)})},checkElementId:function(e,t){var n,i,a,o,r,l,d,s=this;s.loadBy("org_unit",["ID","parentID","code","caption","unitType"],"ID",e,function(c){0!==c.getCount()&&(r=c.getAt(0),s.refreshDiagram(function(){if(a=s.allData[1*t.getAttribute("ID")],i=s.allData[e],o=s.findChildCell(t),n=s.getAddOvelay(t),a.child.length===o.length+1){var r={x:t.geometry.x,y:t.geometry.y+120};(d=s.graph.getModel()).beginUpdate();try{l=s.showElement(t,i,r),n&&s.graph.removeCellOverlay(t,n)}finally{d.endUpdate()}}}))})},loadBy:function(e,t,n,i,a){var o,r=this;o=[{entity:e,requestName:e,method:"select",fieldList:t,whereList:{By:{expression:"["+n+"]",condition:"equal",values:{field:i}}}}],UB.core.UBDataLoader.loadStores({ubRequests:o,setStoreId:!0,callback:function(t){a.call(r,t[e])},scope:this})},initMetaInfo:function(){var e,t,n,i=this;i.orgUnity={},$App.domainInfo.eachEntity(function(a,o){if(a.mixins&&(t=a.mixins.unity)&&t.enabled&&t.entity&&"org_unit"===t.entity.toLowerCase()&&t.defaults)switch(e=t.defaults.unitType,i.orgUnity[e]=n={code:o,unitType:e,caption:a.caption},e){case"ORG":n.image=$App.getImagePath("office.png");break;case"DEP":n.image=$App.getImagePath("user-group.png");break;default:n.image=$App.getImagePath("person.png")}})}}),window.mxBasePath="models/UBE/mxGraph",UB.ux.UBDocument.editors.ubOrgChart="UBE.UBOrgChart",UB.ux.UBDocument.contentTypeMapping["application/uborgchart"]="UBE.UBOrgChart",UB.ux.UBDocument.contentTypeMapping["application/UBOrgChart"]="UBE.UBOrgChart",Ext.define("UBE.WorkflowViewer",{extend:"UB.view.BaseWindow",alias:"widget.workflow",uses:["UB.core.UBApp","UB.core.UBStoreManager","UB.view.NavigationPanel","Ext.ux.window.Notification"],layout:"border",title:"Workflow",width:800,height:600,initComponent:function(){var e=this;e.idPrefix=Ext.id();var t='<div id="'+(e.idPrefix+"graph")+'" class="graph-editor-holder"></div>';e.items=[{region:"west",id:e.idPrefix+"-west",cls:"mx-graph-toolbar",width:200,maxWidth:200,split:!0,collapsible:!0,layout:"fit"},{region:"center",flex:1,cls:"mx-graph-editor",html:t,layout:"fit",listeners:{boxready:function(t){e.initMXEditor()},resize:function(){e.editor.graph.sizeDidChange()}}}],e.callParent(arguments),e.on("boxready",function(){e.getEl().on("keydown",function(t,n){t.srcElement=t.target=document.getElementById(e.idPrefix+"graph")})})},initMXEditor:function(){var e,t,n=mxUtils.load(window.mxBasePath+"/resources/config/workfloweditor.xml").getDocumentElement(),i=this;i.editor=e=new mxEditor(n),t=e.graph,e.setGraphContainer(document.getElementById(i.idPrefix+"graph")),t.setResizeContainer(!0),e.addAction("save",Ext.bind(this.onSaveDiagram,this)),new Ext.Element(e.toolbar.toolbar.container).up("div.mxWindow").remove(),Ext.getCmp(i.idPrefix+"-west").body.dom.appendChild(e.toolbar.toolbar.container),e.keyHandler.handler.target=i.getEl().dom,mxEvent.addListener(i.getEl().dom,"keydown",e.keyHandler.handler.keydownHandler),t.popupMenuHandler.factoryMethod=mxUtils.bind(this,function(t,n,a){var o=i.getEl().dom;return t.div.parent=o,t.zIndex=o.style.zIndex+1,t.div.style.zIndex=o.style.zIndex+1,e.createPopupMenu(t,n,a)}),new mxRubberband(t),t.setPanning(!0),t.setTooltips(!0),e._showOutline=e.showOutline,e.showOutline=Ext.Function.bind(i.showOutline,i),e._showTasks=e.showTasks,e.tasks&&(e.tasks.destroy(),e.tasks=null),e.showTasks=Ext.Function.bind(i.showTasks,i),e.refreshTasks=Ext.Function.bind(i.refreshTasks,i),e.properties=null,e.showProperties=Ext.Function.bind(i.showProperties,i),e.hideProperties=Ext.Function.bind(i.hideProperties,i),e.addAction("toggleOutline",function(e){null===e.outline?e.showOutline():e.outline.setVisible(!e.outline.isVisible())}),this.dataUrl&&e.open(this.dataUrl),this.incomeModel&&e.readGraphModel(this.incomeModel),i.addListener("Close",function(){e&&e.isModified()&&Ext.Msg.confirm("Attention","Diagram was changed. Do you want save changes?",function(e){"yes"===e&&this.saveDiagram()},this)},this)},loadSchema:function(){},refreshTasks:function(e){var t=this;null!==this.tasks&&(t.taskEl.innerHTML="",t.taskEl.createTasks(e))},showTasks:function(){var e,t,n=this,i=n.editor.graph;if(null===n.editor.tasks){var a=document.createElement("div");a.style.padding="4px",a.style.paddingLeft="20px",t=Ext.widget("panel",{border:!0,flex:1}),e=Ext.create("Ext.Window",{title:"Tasks",width:200,height:400,closable:!0,closeAction:"hide",autoDestroy:!1,layout:"fit",items:[t]}).show(),n.taskWnd=e,e.ownerCt=n,e.registerWithOwnerCt();var o=t.getEl().dom;document.getElementById(o.id+"-innerCt").appendChild(a),n.taskEl=a;var r=mxUtils.bind(n,function(e){n.taskEl.innerHTML="",n.editor.createTasks(n.taskEl)});i.getModel().addListener(mxEvent.CHANGE,r),i.getSelectionModel().addListener(mxEvent.CHANGE,r),i.addListener(mxEvent.ROOT,r),n.editor.tasks=e,n.editor.createTasks(a)}n.taskWnd.show()},beforeDestroy:function(){var e=this;e.editor&&e.editor.destroy(),e.tasksWnd&&e.tasksWnd.destroy(),e.outlineWnd&&e.outlineWnd.destroy(),e.callParent(arguments)},showOutline:function(){var e=this,t=e.editor;if(e.outlineWnd)e.outlineWnd.show();else{t._showOutline();var n=Ext.create("Ext.Window",{title:"Overview",width:200,height:200,closable:!0,closeAction:"hide",autoDestroy:!1,layout:"fit"}).show();e.outlineWnd=n,n.ownerCt=e,n.registerWithOwnerCt(),t.outline.setVisible=function(){n.show()};var i=new Ext.Element(t.outline.div).down("div.mxWindowPane");n.body.dom.appendChild(i.dom)}},onSaveDiagram:function(e,t){this.saveDiagram(),this.close()},saveDiagram:function(){if(this.resultCallBack){var e=(new mxCodec).encode(this.editor.graph.getModel());this.resultCallBack(this.editor.isModified(),e),this.editor.modified=!1}},showProperties:function(e){var e,t=this,n=t.editor;if(null===(e=e||n.graph.getSelectionCell())&&null===(e=n.graph.getCurrentRoot())&&(e=n.graph.getModel().getRoot()),null!==e){n.graph.stopEditing(!0),n.hideProperties();var i=n.createProperties(e);if(null!==i){var a=Ext.widget("panel",{border:!0,flex:1}),o=Ext.create("Ext.Window",{title:"Properties",width:250,height:400,closable:!1,layout:"fit",items:[a]}).show();o.ownerCt=t,o.registerWithOwnerCt();var r=a.getEl().dom;document.getElementById(r.id+"-innerCt").appendChild(i),n.properties=o}}},hideProperties:function(){var e=this.editor;null!==e.properties&&(e.properties.close(),e.properties=null)}}),window.mxBasePath="models/UBE/mxGraph";